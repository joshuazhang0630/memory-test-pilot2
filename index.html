<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Test - Scientific Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .feedback-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px 50px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            animation: fadeInOut 1s ease-in-out;
        }
        .feedback-correct {
            background-color: #4CAF50;
            color: white;
        }
        .feedback-miss {
            background-color: #f44336;
            color: white;
        }
        .feedback-false-alarm {
            background-color: #ff9800;
            color: white;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        .instruction-page {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .instruction-page h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .instruction-page p {
            font-size: 18px;
            line-height: 1.8;
            color: #555;
            margin-bottom: 15px;
        }
        .instruction-page ul {
            font-size: 18px;
            line-height: 2;
            color: #555;
            margin-left: 20px;
        }
        .instruction-page strong {
            color: #2196F3;
        }
        .btn-large {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
        .btn-large:hover {
            background-color: #1976D2;
        }
        .pretrain-result {
            max-width: 700px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .pretrain-result h2 {
            color: #4CAF50;
            margin-bottom: 30px;
        }
        .stats-box {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .stats-box p {
            font-size: 20px;
            margin: 10px 0;
            color: #333;
        }
        .tips-box {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        .tips-box h3 {
            color: #1976D2;
            margin-top: 0;
        }
        .tips-box ul {
            color: #555;
            line-height: 1.8;
        }
    </style>
</head>
<body>

<!--- Start the Javascript that does all the hard work! --->
<script type="text/javascript" charset="UTF-8">

/* Modified to include pretrain functionality */

// parameters set by the experimenter
var fixation_address = "http://www.wilmabainbridge.com/datasets/memorabilitycollector/fixation.jpg";
var images = new Array("https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111290/text10_znc0jk.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111289/text8_y2toyy.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111289/text6_vpawfh.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111289/text7_zvkpuc.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111289/text9_tzi3hz.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111288/text3_afetxx.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111288/text4_vylzcd.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111287/text2_cqkf6r.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111287/text1_avjjsj.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111287/surface9_izqjqz.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111288/text5_aqxpnr.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111287/surface10_b02unk.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111286/surface8_szl2lb.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111284/surface7_nwdz2e.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111283/surface4_yi2ngr.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111283/surface6_relhbw.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111283/surface5_matvpr.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111282/surface3_jxvtjf.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111282/surface2_uwmqh1.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111282/surface1_e1c1zi.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111281/point10_hj2b5x.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111280/point8_ypfykh.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111280/point9_j5yiic.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111280/point7_ka9dgx.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111280/point6_gu6vyw.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111280/point5_ednd55.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111278/point4_xetcvh.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111278/point3_d9rozu.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111277/nodelink10_asekig.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111277/point2_oiayvd.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111277/point1_d98lcb.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111277/nodelink9_uzdh5b.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111276/nodelink8_a6dbvd.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111275/nodelink7_qkqbpi.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111275/nodelink6_opfusg.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111275/nodelink5_s31tla.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111274/nodelink4_m3oky1.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111274/nodelink3_exlfzl.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111273/nodelink2_vb0vff.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111272/line10_utszkf.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111273/nodelink1_ycuc0d.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111272/line9_sijrvb.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111272/line8_t93zzj.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111272/line7_lxmnz9.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111270/line6_tq0ief.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111270/line5_sb163r.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111270/line4_iqhekn.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111270/line3_sqis4w.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111269/line2_bpagix.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111268/grid10_napfww.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111268/grid8_keyxfp.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111268/line1_day5yn.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111268/grid9_od8uj9.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111266/grid7_ormde1.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111266/grid6_j1e9sp.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111266/grid3_wf3wn2.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111266/grid5_ti7ut6.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111265/glyph10_fcmvcr.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111265/grid4_if2k6n.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111265/glyph8_fxsral.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111265/grid2_v55hqx.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111265/grid1_efaryh.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111263/glyph9_hkhcim.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111263/glyph7_h7f8tj.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111262/glyph6_w6vxxh.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111262/glyph5_kgt1vt.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111261/glyph3_pghnuh.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111262/glyph4_wskbsu.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111261/glyph2_tqtbwl.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111261/glyph1_dfxi4p.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111260/color10_yiq9ov.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111259/color8_wtraks.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111259/color9_lfg9xx.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111259/color7_clqmwn.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111258/color5_kyavlx.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111258/color6_e4e6i2.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111257/color1_f2iead.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111256/bar10_wsbahb.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111256/bar5_fhwday.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111257/color3_pjmg6s.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111257/color4_znonfg.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111256/bar9_u2ba82.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111256/color2_qm9eyc.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111255/bar8_jnzovj.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111255/bar7_tzacsu.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111255/bar4_nsb0pt.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111254/area6_r5fivi.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111255/bar6_nksyxa.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111254/bar2_hggvkn.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111254/area10_rnnsx2.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111254/bar3_qfh4yl.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111254/bar1_vhudoq.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111253/area7_rjswg9.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111253/area9_rqbel4.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111252/area8_ggkuss.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111252/area4_o4rtbi.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111251/area3_w9nmgq.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111251/area5_smohfc.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111251/area2_ge4gp6.png", "https://res.cloudinary.com/dtthoqqbw/image/upload/v1760111251/area1_fvkfyw.png");

var stimtime = 2000; // in milliseconds
var isi = 1200; // in milliseconds
var delayBetTargets = 120; // in seconds
var delayBetVigilance = 5; // in trials. The size of image blocks
var keytoWatch = "r"; // case doesn't matter
var subsperim = 40; // how many subjects you want per image
var payperhour = 5; // how much money you want to pay per hour
var vigilancecutoff = 10; // the number of vigilances they're allowed to fail before being booted
var facutoff = 20; // the number of false alarms they're allowed to make before being booted
var timeBetweenBreaks = 300; // in seconds
var maxBreakTime = 15; // in seconds 

// text set by the experimenter
var failuretext = "<h2>Finished!</h2>Unfortunately you made too many errors and the game has ended. Press the <b>SUBMIT HIT</b> button to get credit for the hit.<br>";
var donetext = "<h2>Finished!</h2>You have finished the task - great job! Press the <b>SUBMIT HIT</b> button to get credit for the hit.<br>";

// Pretrain variables
var pretrainImages = []; // Will store indices of images used for pretrain
var pretrainSequence = []; // Full pretrain sequence with repeats
var pretrainTypeSequence = []; // Type of each pretrain trial
var pretrainPerfSequence = []; // Performance for pretrain
var inPretrainMode = false;
var pretrainImCount = -1;
var pretrainHits = 0;
var pretrainMisses = 0;
var pretrainFalseAlarms = 0;
var pretrainCorrectRejections = 0;

// global variables that are calculated later based on parameters
var trialsBetTargets = 30; // in num trials
var numfoils = 0;
var numtargets = 0;
var numtotalsubs = 0;
var allc = 0; // overall sequence counter when building the sequence
var experimentlength = 0;
var paypersub = 0;
var totalpay = 0;
var trialsBetweenBreaks = 0;

// full image sequence variables (these are the whole stream, with fixations built in)
// deal with these for when running the experiment
var fullsequence = []; // the sequence of everything (images plus fixation)
var timesequence = []; // the sequence of the timings
var typesequence = []; // the sequence of the image types
var perfsequence = []; // the sequence of the performance
var breakCounter = 0;
var onBreak = false;

// image-only sequence variables (the ordering without fixation or anything extra you add in)
// deal with these when designing the stimulus presentation
var imtypeseq = []; // the sequence of the image types
var allimgseq = []; // the sequence of all the images
var performanceseq = []; // the sequence of performance
var imCount = -1; // trial number that is being shown. Starts from -1 because of setTimeOut quirks

// tracking performance (to determine if they can continue)
var vigilancefails = 0;
var falsealarmcounts = 0;
var kickedOut = 0;

// output variables
var imgstring = "";
var imtypestring = "";
var perfstring = "";

// ID constants for image type
const FIXATION = 0;
const TARGET = 1;
const REPEAT = 2; // target repeat
const FILLER = 3;
const VIGILANCE = 4; // vigilant repeat

// ID constants for performance
const HIT = 11;
const MISS = 12;
const FALSEALARM = 13;
const CORRECTREJECTION = 14;

/****************************************Functions*****************************************/

// Select pretrain images - 15 images, sampling from each category
function selectPretrainImages() {
    // Image categories (10 of each type)
    var categories = [
        {name: 'text', start: 0, end: 10},
        {name: 'surface', start: 10, end: 20},
        {name: 'point', start: 20, end: 30},
        {name: 'nodelink', start: 30, end: 40},
        {name: 'line', start: 40, end: 50},
        {name: 'grid', start: 50, end: 60},
        {name: 'glyph', start: 60, end: 70},
        {name: 'color', start: 70, end: 80},
        {name: 'bar', start: 80, end: 90},
        {name: 'area', start: 90, end: 100}
    ];
    
    var selected = [];
    
    // Sample 1-2 images from each category to get 15 total
    // First pass: take 1 from each (10 images)
    for (var i = 0; i < categories.length; i++) {
        var cat = categories[i];
        var randomIndex = cat.start + Math.floor(Math.random() * (cat.end - cat.start));
        selected.push(randomIndex);
    }
    
    // Second pass: randomly take 5 more from random categories
    for (var i = 0; i < 5; i++) {
        var randomCat = categories[Math.floor(Math.random() * categories.length)];
        var randomIndex = randomCat.start + Math.floor(Math.random() * (randomCat.end - randomCat.start));
        // Make sure we don't duplicate
        if (selected.indexOf(randomIndex) === -1) {
            selected.push(randomIndex);
        } else {
            i--; // Try again
        }
    }
    
    return selected;
}

// Build pretrain sequence with repeats
function buildPretrainSequence() {
    pretrainImages = selectPretrainImages();
    
    // Shuffle the pretrain images
    pretrainImages = shuffleArray(pretrainImages);
    
    // Build sequence with 3 repeats at intervals of 5-10 images
    var sequence = [];
    var types = [];
    var perf = [];
    
    var repeatIndices = [1, 5, 9]; // Which images to repeat
    var repeatPositions = [6, 14, 19]; // Where to place repeats (after 5, 8, 10 images)
    
    var imgCounter = 0;
    var seqPos = 0;
    
    for (var i = 0; i < 21; i++) { // 15 unique + 3 repeats + some extras = 21 total
        if (repeatPositions.indexOf(i) !== -1) {
            // This is a repeat position
            var whichRepeat = repeatPositions.indexOf(i);
            var imgToRepeat = pretrainImages[repeatIndices[whichRepeat]];
            sequence.push(imgToRepeat);
            types.push(REPEAT);
            perf.push(MISS); // Default: they'll miss it
        } else if (imgCounter < pretrainImages.length) {
            // Regular image
            sequence.push(pretrainImages[imgCounter]);
            types.push(TARGET);
            perf.push(CORRECTREJECTION); // Default: correct rejection
            imgCounter++;
        }
    }
    
    pretrainSequence = sequence;
    pretrainTypeSequence = types;
    pretrainPerfSequence = perf;
    
    console.log("Pretrain sequence built:", pretrainSequence.length, "images");
}

// Show instruction page
function showInstructions() {
    document.body.innerHTML = `
        <div class="instruction-page">
            <h2>Welcome to the Visual Memory Test!</h2>
            <p>In this experiment, you will see a stream of scientific visualization images. Your task is simple:</p>
            <ul>
                <li><strong>Watch each image carefully</strong> as it appears for 1 second</li>
                <li><strong>Press the SPACE key</strong> (or click the MARK button) immediately when you see an image that you have seen before</li>
                <li>Between images, you will see a <strong>+ symbol</strong> - do not press anything during this time</li>
            </ul>
            <p><strong>Important:</strong></p>
            <ul>
                <li>Some images will repeat after a while - that's when you should press!</li>
                <li>Pay close attention - repeated images may look very similar to others</li>
                <li>It's okay to make mistakes during practice</li>
            </ul>
            <p>Let's start with a short <strong>practice round</strong> to help you get familiar with the task.</p>
            <center>
                <button class="btn-large" onclick="startPretrain()">Start Practice</button>
            </center>
        </div>
    `;
}

// Start pretrain
function startPretrain() {
    inPretrainMode = true;
    pretrainImCount = -1;
    
    // Reset counters
    pretrainHits = 0;
    pretrainMisses = 0;
    pretrainFalseAlarms = 0;
    pretrainCorrectRejections = 0;
    
    // Show the main interface
    document.body.innerHTML = `
        <form id="form" autocomplete="off">
        <input type = "hidden" name = "imseq" id = "imseqout" value = "">
        <input type = "hidden" name = "imtypeseq" id = "imtypeseqout" value = "">
        <input type = "hidden" name = "perfseq" id = "perfseqout" value = "">
        <input type = "hidden" name = "ending" id = "endingout" value = "">

        <center>
        <h1>Practice Round</h1>
        <table style="border:1px solid black"><tr>
        <td style="border:1px solid black"><center><p><span id = "instructions">Press the <b>'SPACE'</b> key (or the MARK button) when you see a <b>repeated image</b>. Ready?</span></p></center></td></tr>
        <tr><td height=450 width=450 style="vertical-align:middle"><center>
        <span id = "performancerecord">Press <b>SPACE</b> or click <b>MARK</b> to begin practice</span>
        <div id = "imagesequence"><img id = "stimulus" src = "${fixation_address}"></div>
        <style>
        #stimulus {
            max-width: 400px;
            max-height: 400px;
        }
        </style>
        </center></td></tr></table>
        <br>
        <h3><button type = "button" id = "markbutton" onclick = "processResponseM()" style="border: 1px solid black; height:50; width:50; border-radius:8px">Mark</button></h3><br>
        </center>
        </form>
    `;
}

// Animate pretrain sequence
function animatePretrainSequence() {
    pretrainImCount++;
    
    if (pretrainImCount >= pretrainSequence.length * 2) { // *2 because we have fixations
        // Pretrain finished
        showPretrainResults();
        return;
    }
    
    // Determine if it's an image or fixation
    var isImage = (pretrainImCount % 2 === 0);
    
    if (isImage) {
        var imgIndex = Math.floor(pretrainImCount / 2);
        document.getElementById("stimulus").src = images[pretrainSequence[imgIndex]];
        setTimeout("animatePretrainSequence()", stimtime);
    } else {
        document.getElementById("stimulus").src = fixation_address;
        setTimeout("animatePretrainSequence()", isi);
    }
}

// Show feedback for pretrain
function showPretrainFeedback(type) {
    var feedback = document.createElement('div');
    feedback.className = 'feedback-overlay feedback-' + type;
    
    if (type === 'correct') {
        feedback.innerHTML = '‚úÖ Correct! You spotted the repeat!';
    } else if (type === 'miss') {
        feedback.innerHTML = '‚ùå Missed! This image was shown before.';
    } else if (type === 'false-alarm') {
        feedback.innerHTML = '‚ö†Ô∏è False Alarm! This is a new image.';
    }
    
    document.body.appendChild(feedback);
    
    setTimeout(function() {
        document.body.removeChild(feedback);
    }, 1000);
}

// Process pretrain response
function processPretrainResponse() {
    if (pretrainImCount < 0) {
        // Start the pretrain
        document.getElementById("performancerecord").innerHTML = "";
        animatePretrainSequence();
        return;
    }
    
    var isImage = (pretrainImCount % 2 === 0);
    if (!isImage && pretrainImCount > 0) {
        // They pressed during fixation, check previous image
        var imgIndex = Math.floor((pretrainImCount - 1) / 2);
        var trialType = pretrainTypeSequence[imgIndex];
        
        if (trialType === REPEAT) {
            // Hit!
            pretrainPerfSequence[imgIndex] = HIT;
            pretrainHits++;
            showPretrainFeedback('correct');
        } else {
            // False alarm
            pretrainPerfSequence[imgIndex] = FALSEALARM;
            pretrainFalseAlarms++;
            showPretrainFeedback('false-alarm');
        }
    } else if (isImage) {
        var imgIndex = Math.floor(pretrainImCount / 2);
        var trialType = pretrainTypeSequence[imgIndex];
        
        if (trialType === REPEAT) {
            // Hit!
            pretrainPerfSequence[imgIndex] = HIT;
            pretrainHits++;
            showPretrainFeedback('correct');
        } else {
            // False alarm
            pretrainPerfSequence[imgIndex] = FALSEALARM;
            pretrainFalseAlarms++;
            showPretrainFeedback('false-alarm');
        }
    }
}

// Show pretrain results
function showPretrainResults() {
    // Count misses and correct rejections
    for (var i = 0; i < pretrainPerfSequence.length; i++) {
        if (pretrainPerfSequence[i] === MISS) {
            pretrainMisses++;
        } else if (pretrainPerfSequence[i] === CORRECTREJECTION) {
            pretrainCorrectRejections++;
        }
    }
    
    var totalRepeats = 3;
    var accuracy = Math.round((pretrainHits / totalRepeats) * 100);
    
    document.body.innerHTML = `
        <div class="pretrain-result">
            <h2>üéâ Practice Complete!</h2>
            
            <div class="stats-box">
                <p><strong>Your Performance:</strong></p>
                <p>Repeats detected: <strong>${pretrainHits} / ${totalRepeats}</strong></p>
                <p>Accuracy: <strong>${accuracy}%</strong></p>
                <p>False alarms: <strong>${pretrainFalseAlarms}</strong></p>
            </div>
            
            <div class="tips-box">
                <h3>üí° Tips for the Real Test:</h3>
                <ul>
                    <li><strong>Stay focused</strong> - the real test will be longer</li>
                    <li><strong>React quickly</strong> when you see a repeat</li>
                    <li><strong>Don't worry</strong> if you make mistakes - just do your best!</li>
                    <li>Remember: Press only when you see a <strong>repeated image</strong></li>
                </ul>
            </div>
            
            <p style="margin-top: 30px; color: #666;">The real experiment will now begin. Good luck!</p>
            
            <center>
                <button class="btn-large" onclick="startRealExperiment()">Start Real Experiment</button>
            </center>
        </div>
    `;
}

// Start real experiment
function startRealExperiment() {
    inPretrainMode = false;
    
    // Remove pretrain images from the main image array
    var newImages = [];
    for (var i = 0; i < images.length; i++) {
        if (pretrainImages.indexOf(i) === -1) {
            newImages.push(images[i]);
        }
    }
    images = newImages;
    
    console.log("Starting real experiment with", images.length, "images");
    
    // Show the main interface
    document.body.innerHTML = `
        <form id="form" autocomplete="off">
        <input type = "hidden" name = "imseq" id = "imseqout" value = "">
        <input type = "hidden" name = "imtypeseq" id = "imtypeseqout" value = "">
        <input type = "hidden" name = "perfseq" id = "perfseqout" value = "">
        <input type = "hidden" name = "ending" id = "endingout" value = "">

        <center>
        <h1>Memory Test</h1>
        <table style="border:1px solid black"><tr>
        <td style="border:1px solid black"><center><p><span id = "instructions">Press the <b>'r'</b> key (or the mark button if you're a mobile user) when you see a <b>repeated image</b>.</span></p></center></td></tr>
        <tr><td height=450 width=450 style="vertical-align:middle"><center>
        <span id = "performancerecord">Press the <b>R key</b> (or the mark button) to start. Click in this window first if needed.</span>
        <div id = "imagesequence"><img id = "stimulus" src = "${fixation_address}"></div>
        <style>
        #stimulus {
            max-width: 400px;
            max-height: 400px;
        }
        </style>
        </center></td></tr></table>
        <br>
        <h3><button type = "button" id = "markbutton" onclick = "processResponseM()" style="border: 1px solid black; height:50; width:50; border-radius:8px">Mark</button></h3><br>
        <p><span id = "consentinfo">By making judgements about these images, you are participating in a study being performed by students at Ohio State University. Your participation in this research is voluntary.</span></p>
        <b>Click here to submit your HIT.</b> Only submit when completed!<br><br>
        <input type = "submit" id="submitbutton" name="Submit HIT" value="Submit HIT">
        </center>
        </form>
    `;
    
    // Setup form submission
    document.getElementById("form").onsubmit = function(e){
        e.preventDefault();
        saveProgress();
        sendToSheets();
        document.getElementById('form').style.display = 'none';
        let thankYouDiv = document.createElement('div');
        thankYouDiv.id = 'thankyou';
        thankYouDiv.style.textAlign = 'center';
        thankYouDiv.innerHTML = `<h2>Thank you for participating!</h2><p>Your responses have been recorded. You may now close this window.</p>`;
        document.body.appendChild(thankYouDiv);
    };
    
    // Now preload and start the real experiment
    preloadEverything();
}

// key press listener
document.onkeydown = function(key){ 
    if (inPretrainMode) {
        if (String.fromCharCode(key.keyCode).toLowerCase() === ' ' || 
            String.fromCharCode(key.keyCode).toLowerCase() === 'space') {
            processPretrainResponse();
        }
    } else {
        processResponse(key);
    }
};

document.addEventListener('keydown', function(event) {
    if (onBreak && event.key.toLowerCase() === 'c') {
        giveBreak(1);
    }
});

// preload and then start
function buttonPress(){
	document.getElementById("startbutton").innerHTML = "Experiment Running...";
	document.getElementById("startbutton").disabled = true;
	preloadEverything();
	document.getElementById("performancerecord").innerHTML = "Press the <b>R key</b> (or the mark button for mobile users) to start. If it doesn't work, make sure to click in this browser window first.";
}

// recursive function that shows the images in a sequence
function animateSequence(){
	saveProgress();
	
	determineFailure();
	if (kickedOut){
		showFailure();
		return;
	}
	
	if (breakCounter >= trialsBetweenBreaks) {
		giveBreak(0);
		breakCounter = -1;
		return;
	}
	breakCounter++;
	
	imCount++;
	if (imCount == fullsequence.length){
		showEnding();
		return;
	}
	document.getElementById("stimulus").src = fullsequence[imCount];
	
	setTimeout("animateSequence()", timesequence[imCount]);
}

// preload and calculate everything
function preloadEverything() {
	calculateProps();
	makeImSequence();
	calculateTotalPay();
	buildFullSequence();
}

// allows the participant to take a break
function giveBreak(going){
	if (going){
		onBreak = false;
		document.getElementById("performancerecord").innerHTML = '';
		setTimeout("animateSequence()", timesequence[imCount])
		return;
	}
	onBreak = true;
	document.getElementById("stimulus").src = fixation_address;
	document.getElementById("performancerecord").innerHTML = '<h2>Break time!</h2>Good job - you will now get a break. Please do not break for longer than ' + maxBreakTime + ' seconds or the HIT will continue without you. Press "<b>C</b>" to continue.';
	
	setTimeout("giveBreak(1)", maxBreakTime*1000);
}

// builds the full sequence with both images and fixations, as well as timings
function buildFullSequence(){
	var i = 0;
	var imcounter = 0;
	while (i < imtypeseq.length*2){
		fullsequence[i] = images[allimgseq[imcounter]];
		typesequence[i] = imtypeseq[imcounter];
		timesequence[i] = stimtime;
		perfsequence[i] = performanceseq[imcounter];
		i++;
		imcounter++;
		
		fullsequence[i] = fixation_address;
		typesequence[i] = FIXATION;
		timesequence[i] = isi;
		perfsequence[i] = FIXATION;
		i++;
	}
	console.log("Done building the full sequence.");
}

// get the key and respond
function processResponse(key){
	if(String.fromCharCode(key.keyCode).toLowerCase() == keytoWatch.toLowerCase()){
		var trialtype = typesequence[imCount];
		if (imCount<0) {
			document.getElementById("performancerecord").innerHTML = "";
			animateSequence();
		}
		if ((trialtype == FIXATION) && imCount > 0) {
			trialtype = typesequence[imCount-1];
		}
		if (trialtype == REPEAT | trialtype == VIGILANCE) {
			perfsequence[imCount] = HIT;
			console.log("Hit!");
		} else if (trialtype == TARGET | trialtype == FILLER) {
			perfsequence[imCount] = FALSEALARM;
			console.log("False alarm!");
		}
	}
}

// for mobile
function processResponseM(){
    if (inPretrainMode) {
        processPretrainResponse();
        return;
    }
    
	var trialtype = typesequence[imCount];
	if (imCount<0) {
		document.getElementById("performancerecord").innerHTML = "";
		animateSequence();
	}
	if ((trialtype == FIXATION) && imCount > 0) {
		trialtype = typesequence[imCount-1];
	}
	if (trialtype == REPEAT | trialtype == VIGILANCE) {
		perfsequence[imCount] = HIT;
		console.log("Hit!");
	} else if (trialtype == TARGET | trialtype == FILLER) {
		perfsequence[imCount] = FALSEALARM;
		console.log("False alarm!");
	}
}

// decide if they've failed too much
function determineFailure(){
	if (perfsequence[imCount] == FALSEALARM){
		falsealarmcounts++;
		console.log("False alarm count: " + falsealarmcounts);
	}
	if (falsealarmcounts >= facutoff){
		kickedOut = 1;
	}
	
	if (perfsequence[imCount] == MISS & typesequence[imCount] == VIGILANCE){
		vigilancefails++;
		console.log("Vigilance miss count: " + vigilancefails);
	}
	if (vigilancefails >= vigilancecutoff){
		kickedOut = 1;
	}
}

// visually show their failure!
function showFailure(){
	document.getElementById("performancerecord").innerHTML = failuretext;
	propcompleted = imCount/fullsequence.length*100;
	propcompleted = propcompleted.toFixed(2);
	document.getElementById("endingout").value = "failed@" + propcompleted + "%";
}

// end the game if they make it to the end!
function showEnding(){
	document.getElementById("performancerecord").innerHTML = donetext;
	document.getElementById("endingout").value = "completed";
}

// create the memorability-based image sequence
function makeImSequence(){
	var allImArray = populateArray(0, images.length);
	allImArray = shuffleArray(allImArray);
	var targetIms = allImArray.slice(0, numtargets);
	var fillerIms = allImArray.slice(numtargets, allImArray.length);
	var imblock = [];
	var typeblock = [];
	var perfblock = [];

	targetIms = shuffleArray(targetIms);
	repeatIms = shuffleArray(targetIms);
	fillerIms = shuffleArray(fillerIms);
	
	tc = 0;
	fc = 0;
	ofbc = 0;
	rc = 0;
	allc = 0;
	
	oldfillblock = [];
	
	while (rc < repeatIms.length & fc < fillerIms.length){
		var c = 0;
		
		if (tc < targetIms.length) {
			imblock[c] = targetIms[tc]; 
			typeblock[c] = TARGET;
			perfblock[c] = CORRECTREJECTION;
			tc++; c++; allc++;
		} else {
			imblock[c] = fillerIms[fc];
			typeblock[c] = FILLER;
			perfblock[c] = CORRECTREJECTION;
			oldfillblock[ofbc] = fillerIms[fc];
			c++; allc++; ofbc++; fc++;
		}
	
		if (oldfillblock.length > 0) {
			oldfillblock = shuffleArray(oldfillblock);
			imblock[c] = oldfillblock[0];
			typeblock[c] = VIGILANCE;
			perfblock[c] = MISS;
			c++; allc++;
			oldfillblock = []; ofbc = 0;
		} else {
			imblock[c] = fillerIms[fc];
			typeblock[c] = FILLER;
			perfblock[c] = CORRECTREJECTION;
			oldfillblock[ofbc] = fillerIms[fc]; 
			c++; allc++; ofbc++; fc++;
		}
	
		if (allc > trialsBetTargets) {
			imblock[c] = repeatIms[rc];
			typeblock[c] = REPEAT;
			perfblock[c] = MISS;
			rc++; c++; allc++;
		} else{
			imblock[c] = fillerIms[fc];
			typeblock[c] = FILLER;
			perfblock[c] = CORRECTREJECTION;
			oldfillblock[ofbc] = fillerIms[fc]; 
			c++; allc++; ofbc++; fc++;
		}
	
		for (var i = 0; i < delayBetVigilance-3; i++){
			if (fc < fillerIms.length) {
				imblock[c] = fillerIms[fc]; 
				typeblock[c] = FILLER;
				perfblock[c] = CORRECTREJECTION;
				oldfillblock[ofbc] = fillerIms[fc];
				c++; allc++; ofbc++; fc++;
			}
		}
		
		[imblock, typeblock, perfblock] = shuffleArrays([imblock, typeblock, perfblock]);
		
		allimgseq = allimgseq.concat(imblock);
		imtypeseq = imtypeseq.concat(typeblock);
		performanceseq = performanceseq.concat(perfblock);
	
	}
	
	console.log("Done making the image sequence!");
}

// calculate the proportions of targets and foils
function calculateProps(){
	var trialtime = stimtime + isi;
	trialsBetTargets = Math.floor(delayBetTargets*1000 / trialtime);
	var B = trialsBetTargets;
	var S = delayBetVigilance;
	var C = images.length;
	
	numfoils = (S-1 + (S-2)*(C+(B/S)-1)-(B/S))/(S-1);
	numtargets = C - numfoils;
	
	numfoils = Math.floor(numfoils);
	numtargets = Math.ceil(numtargets);
	
	trialsBetweenBreaks = Math.ceil(timeBetweenBreaks*1000/trialtime);
	
	console.log("Calculated the proportions of images.");
}

// calculate the total pay for the whole study
function calculateTotalPay(){
	var proptargets = images.length / numtargets;
	numtotalsubs = proptargets * subsperim;
	
	experimentlength = (allc * (stimtime + isi)/1000)/60;
	paypersub = experimentlength/60 * payperhour;
	totalpay = paypersub * numtotalsubs;
	
	console.log("Calculated the pay amounts.");
}

function reportVariables(){
	var report = " With your " + images.length + " total images, if you want " + delayBetTargets + "s between target images,\n You will need " + numtargets + " targets and " + numfoils + " foils.\n This will result in an experiment that is " + experimentlength + "min long.\n To get " + subsperim + " subjects per target image, you will need " + numtotalsubs + " total subjects.\n At a rate of $" + payperhour + " per hour, each experiment will cost $" + paypersub + ",\n Or $" + totalpay + " for the whole study.";
	
	console.log(report);
}

// save to the output variables the performance and sequence completed so far
function saveProgress(){
	if (imCount >= 0) {
		var tempimg = fullsequence[imCount];
		tempimg = tempimg.substring(tempimg.lastIndexOf("/")+1);
		if (imCount > 0) {
			imgstring = imgstring + ",";
			imtypestring = imtypestring + ",";
			perfstring = perfstring + ",";
		}
		imgstring = imgstring + tempimg;
		imtypestring = imtypestring + typesequence[imCount];
		perfstring = perfstring + perfsequence[imCount];
		document.getElementById("imseqout").value = imgstring;
		document.getElementById("imtypeseqout").value = imtypestring;
		document.getElementById("perfseqout").value = perfstring;
	}
}

/*************************************** General useful functions **********************************************/

function populateArray(start, end){
	array = [];
	for (var i = start; i < end; i++){
		array[i] = i;
	}
	return array;
}

function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
    return array;
}

function shuffleArrays(arrays){
	for (var i = arrays[0].length - 1; i > 0; i--) {
		var j = Math.floor(Math.random() * (i + 1));
		for (var an = 0; an < arrays.length; an++) {
			var temp = arrays[an][i];
			arrays[an][i] = arrays[an][j];
			arrays[an][j] = temp;
		}
	}
	return arrays;
}
			
function countOccurences(array, value){
	var counter = 0;
	for (var i = 0; i < array.length; i++){
		if (array[i] == value){
			counter++;
		}
	}
	return counter;
}

function sendToSheets() {
	const form = document.getElementById('form');
    const formData = new FormData(form);
    const data = {
		prolific_id: pid,
		imseq: imgstring,
        imtypeseq: imtypestring,
        perfseq: perfstring,
        ending: document.getElementById("endingout").value,
        vigilancefails: vigilancefails,
        falsealarmcounts: falsealarmcounts
	};
	const appsURL = "https://script.google.com/macros/s/AKfycbwHrtdpZCQxWMxM4eEygi0ucWYixxAPEKHaYob6n5ArJkQDg1ifrDHb_Hd94ZNxzzz7/exec";
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }

    data.vigilancefails = vigilancefails;
    data.falsealarmcounts = falsealarmcounts;

    console.log("data", data);

    fetch(appsURL, {
        method: "POST",
		mode: "no-cors",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    }).then(() => {
        console.log("Data sent to Google Sheets!");
    }).catch(err => console.error("Error:", err));
}

// Initialize - show splash screen first
var pid = '';
</script>

<body>
<div id="splash" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#fff;z-index:9999;display:flex;align-items:center;justify-content:center;">
  	<form id="prolific-form" style="text-align:center;">
    	<h2>Welcome!</h2>
    	<p>Please enter your Prolific ID to begin:</p>
    	<input type="text" id="prolific-id-input" name="prolific_id" required placeholder="Prolific ID" style="font-size:1.2em;padding:8px;">
    	<br><br>
    	<button type="submit" style="font-size:1.1em;padding:8px 24px;">Start</button>
  	</form>
</div>

<script>
  	document.getElementById('prolific-form').onsubmit = function(e) {
   		e.preventDefault();
    	pid = document.getElementById('prolific-id-input').value.trim();
    	if(pid) {
      		document.getElementById('splash').style.display = 'none';
      		
      		// Build pretrain sequence
      		buildPretrainSequence();
      		
      		// Show instructions
      		showInstructions();
    	}
  	};
</script>
</body>
</html>
